---
title: "One4All_LA13"
author: "Braden Griebel,Ahyo Falick, Andrew Duffy, Luke Fanning"
date: "11/23/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(stringr)
library(purrr)
library(readxl)
```


## Data Import:

```{r message=F , warning=F}
co2_per_person<-read_csv(file="co2_emissions_tonnes_per_person.csv")
co2_economic<-read_csv(file = "co2_intensity_of_economic_output_kg_co2_per_2011_ppp_of_gdp.csv")
co2_cummulative<-read_csv(file = "cumulative_co2_emissions_tonnes.csv")
co2_emissions<-read_csv(file = "yearly_co2_emissions_1000_tonnes.csv")
forest_coverage<-read_csv(file="forest_coverage_percent.csv")

regions<-read_excel(path="Data Geographies - v1 - by Gapminder.xlsx",sheet="list-of-countries-etc")

co2_per_person<-co2_per_person%>%select(country,`1990`:`2014`)
co2_economic<-co2_economic%>%select(country,`1990`:`2014`)
co2_cummulative<-co2_cummulative%>%select(country,`1990`:`2014`)
co2_emissions<-co2_emissions%>%select(country,`1990`:`2014`)
forest_coverage<-forest_coverage%>%select(country,`1990`:`2014`)

co2_per_person<-co2_per_person%>%gather(`1990`:`2014`,key="year",value="co2_emissions_tonnes_per_person")
co2_economic<-co2_economic%>%gather(`1990`:`2014`,key="year",value="co2_intensity_of_economic_output_kg_co2_per_2011_ppp_of_gdp")
co2_cummulative<-co2_cummulative%>%gather(`1990`:`2014`,key="year",value="cumulative_co2_emissions_tonnes")
co2_emissions<-co2_emissions%>%gather(`1990`:`2014`,key="year",value="yearly_co2_emissions_1000_tonnes")
forest_coverage<-forest_coverage%>%gather(`1990`:`2014`,key="year",value="forest_coverage_percent")

data<-list(co2_per_person,co2_economic,co2_cummulative,co2_emissions,forest_coverage)

co2_data<-data%>%reduce(full_join)

regions<-regions%>%select(name,four_regions,eight_regions,`World bank region`)%>%rename("country"=name,"continent"=four_regions,"continent_spec"= eight_regions,"wbr"=`World bank region`)
co2_data<-co2_data%>%left_join(regions, by="country")
```



```{r message=F , warning=F}
perm_mean <- function(perms = 1000, all_values, n_A)
{
  ## Variables ##
  # perms: The number of permutations 
  # all_values (num): all data values
  # n_A (int): Size of group A
  ###############
  
  # Step 1:
  # Create vector of zeroes of length "perms" to store
  # permuted mean differnces
  permuted_mean_differences<-rep(0,perms)
  
  # Loop throught number of permutations
  for (i in c(1:perms))
  {
    # Step 2:
    # Randomly separate vector "values" into disjoint 
    # groups of size "nA" and "nB" respectively
    temp<-sample(all_values)
    group_A<-temp[1:n_A]
    group_B<-temp[(n_A+1):length(temp)]
    
    # Step 3:
    # Compute the sample means for the two groups from 
    # step 2
    mean_A<-mean(group_A,na.rm=T)
    mean_B<-mean(group_B,na.rm=T)
    
    
    # Step 4: 
    # Compute the difference in sample means, store the
    # value in the vector from step 1
    permuted_mean_differences[i]<-mean_A-mean_B
    
  }
  
  # Step 5:
  # Return the permuted mean differences vector
  return(permuted_mean_differences)
  
}
```


```{r message=F , warning=F}
perm_cor <- function(perms = 1000, x, y)
{
  ## Variables ##
  # perms: The number of permutations 
  # x: Vector of Variable 1 - for computing correlation
  # y: Vector of Variable 2 - for computing correlation
  ###############
  
  # Step 1:
  # Create vector of zeroes of length "perms" to store
  # permuted mean differnces
  correlations<-rep(0,perms)
  
  
  # Loop throught number of permutations
  for (i in c(1:perms))
  {
    # Step 2:
    # Randomly mix up the values in the vector "y"
    temp<-sample(y)
    
    # Step 3:
    # Compute the correlation between x and the randomly mixed
    # up y-vector. Store this value in the vector from step 1.
    correlations[i]<-cor(x,temp,use="pairwise.complete.obs")
    
  }
  
  # Step 4:
  # Return new updated vector, created in step 1
  return(correlations)
  
}

```


```{r message=F , warning=F}
co2_data<-co2_data%>%mutate(year=as.double(year))
co2_data
```


## Team Section:
### Question:    
Is the correlation coefficient between year and co2_emmisions_tonnes_per_person different between the Americas and Europe?

### Importance:     
This question is important because it allows us to see how different the correlation of year and co2_emissions_tonnes_per_person are between the Americas and Europe. Understanding how this correlation differs between Europe and the Americas would allow us to understand what factors that affect this correlation. The Americas and Europe both have simmilar levels of developement, and economies so these confounding variables are of less concern. Understanding the factors that affect the correlation between year and per capita $CO_2$ correlations would allow the institution of policies that decrease the correlation. As the global climate continues to change, largely due to the emission of $CO_2$, we need to work on decreasing our emissions. If we were able to reduce the correlation between year (i.e. level of developement) and per capita $CO_2$ emission we could continue to have our current level of technological advancement, while decreasing the per capita $CO_2$ emissions to fight climate change.       



### Data:  
The data was from the gapminder website, it included 5 datasets.   
1.  Cumulative $CO_2$ emissions in tonnes, which is the total $CO_2$ emitted by the country summed over the years it has been emitting $CO_2$   
2.  Yearly $CO_2$ emissions, the tonnes of $CO_2$ emitted by the country measured in 1000 tonnes   
3.  $CO_2$ emissions per capita, the tonnes of $CO_2$ that the country emitted divided by its population            
4.  $CO_2$ emission intensity of economic output, Emission intensity is the average emission rate of a given pollutant from a given source relative to the intensity of a specific activity, in this case economic activity    
5.  The percentage of the country covered in forest        
All of these are by year, most only had full data from between 1990 and 2014, so that was the data we focused on, using the select function to narrow the dataset to these years. To tidy the data, we first gathered the years into a single column. Initially, each year had its own column, but since the year is really a variable, the principles of tidy data dictate that it should be in a single column. Then, the datasets were combined using the full_join function, combining the data by country. Since this was a binary operation and 5 datasets needed to be combined, we used the reduce function to repeatedly apply it. 


### Hypotheses:   
Test Statistic: The test statistic will be the mean, to determine if there is a difference between correlation of year and co2_emissions_tonnes_per_person    
$H_0:$  $\mu_{Americas\ Correlation\ Coefficients}-\mu_{Europes\ Correlation\ Coefficients}=0$                    
$H_1:$  $\mu_{Americas\ Correlation\ Coefficients}-\mu_{Europes\ Correlation\ Coefficients}\neq0$            




```{r message=F , warning=F}

models <- co2_data %>% 
  split(.$country) %>% 
  map(~lm(co2_emissions_tonnes_per_person ~ year, data = .))
#models




correlation_coefficient<-models %>% 
  map(summary) %>% 
  map_dbl(~.$r.squared)
continents<-co2_data%>%select(country,continent)
df<-tibble("country"=names(correlation_coefficient),"cor"=correlation_coefficient)
df<-left_join(df,continents,by="country")
europe_correlations<-df%>%filter(continent=="europe")
americas_correlations<-df%>%filter(continent=="americas")
actual_mean_difference<-mean(americas_correlations$cor,na.rm=T)-mean(europe_correlations$cor,na.rm=T)

AE_correlations<-df%>%filter(continent=="americas"|continent=="europe")
permuted_means<-tibble("correlation"=perm_mean(perms=1000,all_values = AE_correlations$cor, n_A = nrow(americas_correlations)))
ggplot(permuted_means,aes(correlation,fill=(correlation<quantile(correlation,probs = c(.025),na.rm=T)[[1]]|correlation>quantile(correlation,probs = c(.975),na.rm=T)[[1]])))+
  geom_histogram(binwidth = .003)+
  geom_vline(xintercept=actual_mean_difference,color="red")+
  labs(fill="Tails")
per<-nrow(filter(permuted_means,correlation<actual_mean_difference))/nrow(permuted_means)
percentile<-tibble("Mean Difference"=actual_mean_difference,"Percentile"=per)
percentile
```

### Findings:
From the above graph it can be seen that the difference in the means of the correlations is in the tails of the graph. This is further supported by the percentile of the calculated mean difference, namely 1. It is higher than 100% of th randomly generated mean differences. This clearly suggests that there is a difference in the correlation of year and per capita $CO_2$ emission between Europe and the Americas. Also, since it is to the right, the correlation is higher in the Americas than in EUrope. That is, in the Americas the $CO_2$ per capita emissions, is less corelated to the year. Thus, we would recomend policies that make the americas more closely match Europe in terms of per capita $CO_2$ emissions, to decrease the correlation between the year and $CO_2$ per capita emissions. Decreasing this correlation would mean that the yearly tendency to increase $CO_2$ emissions, would then decrease and so would overall emission levels.






## Braden Individual Section:    
### Question:       
Is there a correlation between the percentage of a country covered in forests and the $CO_2$ intensity of their economies (Emission intensity is the average emission rate of a given pollutant from a given source relative to the intensity of a specific activity, in this case economic activity).           


### Importance:    
This question is important because it allows us to understand the realtionship between the economic release of $CO_2$ and how much of a country is covered in forests. Since countries with a high percentage of forest cover will tend to have an economy tied to this resource, this relationship can illuminate the relationship between economic activity involving forestry and its impact on the $CO_2$ emmisions of a country. An understanding of this relaitonship could allow for policies to decrease the amount of $CO_2$ produced from economic activities. This is important becuase now, more than ever we need to be able to control the amount of $CO_2$ released into the atmosphere. If it is found that forestry activity increases the economic output of $CO_2$, then policies to move away from dependence on this economic acticity could be implemented. However, if forestry is found to decrease the emission rate of $CO_2$ relative to economic intensity, then economic activities related to forestry could be encouraged.       

### Hypotheses:
$H_0:$ There is no correlation between the forest cover of a country and the econonomic intensity of $CO_2$, i.e. $\rho=0$      
$H_1:$There is a correlation between the forest cover of a country and the econonomic intensity of $CO_2$, i.e. $\rho\neq0$      
Test Statistic: The correlation between the forest coverage and economic emmision intensity of $CO_2$


```{r message=FALSE,warning=FALSE}
#The code below takes the co2 data and maps the mean median and sd functions to all the numeric columns in the co2 data set, it was used to explore the characteristics of each of the columns before further examination
#using a permutation test
summary_mean<-co2_data%>%select(co2_emissions_tonnes_per_person:forest_coverage_percent)%>%map(mean,na.rm=T)
summary_mean<-as_tibble(summary_mean)%>%mutate(statistic="mean")
summary_median<-co2_data%>%select(co2_emissions_tonnes_per_person:forest_coverage_percent)%>%map(median,na.rm=T)
summary_median<-as_tibble(summary_median)%>%mutate(statistic="median")
summary_sd<-co2_data%>%select(co2_emissions_tonnes_per_person:forest_coverage_percent)%>%map(sd,na.rm=T)
summary_sd<-as_tibble(summary_sd)%>%mutate(statistic="sd")
summar<-reduce(list(summary_mean,summary_median,summary_sd),full_join)
summar<-summar%>%select(statistic,co2_emissions_tonnes_per_person:forest_coverage_percent)
summar

actual_correlation<-cor(co2_data$forest_coverage_percent,co2_data$co2_intensity_of_economic_output_kg_co2_per_2011_ppp_of_gdp, use="pairwise.complete.obs")




correlations_generated<-tibble(correlation=perm_cor(perms=1000,co2_data$forest_coverage_percent,co2_data$co2_intensity_of_economic_output_kg_co2_per_2011_ppp_of_gdp))


ggplot(data=correlations_generated,aes(correlation,fill=(correlation<quantile(correlation,probs = c(.025),na.rm=T)[[1]]|correlation>quantile(correlation,probs = c(.975),na.rm=T)[[1]])))+
  geom_histogram()+
  geom_vline(xintercept = actual_correlation,color="red")+
  labs(title="Correlation Permutation Test Between CO2 Economic Intensity and Forest Cover",fill="Tails")

percentile<-nrow(filter(correlations_generated,correlation<actual_correlation))/nrow(correlations_generated)


correlation_summary<-tibble("Correlation"=c(actual_correlation),"Percentile"=c(percentile))
correlation_summary


```


### Findings    
From the above graph, it is clear that the correlation is more negative than would be expected if the labels were not important. It is clearly in the tails of the graph, and in fact it has a percentile of 0, so the correlation is most likely statistically significant. The negative value of this correlation shows that as percentage of forest cover increases, the Emission intesnsity of $CO_2$ from the economy decreases. Though this could be indicative of a relationship between the forest cover and economic production of $CO_2$, the confounding variable of size is important to take into account. Smaller countries could tend to have more forest cover, and also tend to have economies whose with less relation to $CO_2$ production. However, this statistically significant correlation does warrant further research. 


## Luke Fanning Individual Section
### Question: 
Is there a noticeable difference in means of forest coverage percentage between the two continents with the current highest nominal GDP, Asia and North America?

### Importance:
Throughout periods of high industrialization in most developed countries, there were large deforestation efforts in place in order to maximize the ability of those countries to succeed and advance. However, there are many smaller countries in the Asian continent, with the primary example being Japan, who may have also had to find other methods to support their industrialization, as the smaller forest area avaliable to them disallowed them from using deforestation to advance their development efforts. While replanting efforts have been in full swing now across the world for many years, and many national parks and other conservation efforts have been made specifically in North America, significant damage has likely been done in these smaller industrialized countries in Asia, as while they may have had to find various other ways to support their industrialization efforts, there is a high likelihood that a lot of their forested areas would've had to be removed to both support their industrialization as well as to make room for a more industrialized society.Therefore, it will be interesting to compare the mean forest coverage percentages from both continents from 1990 onwards to see if there is a significant difference between the two regions with the highest GDP's in the world and analyze their deforestation percentages in order to obtain those GDP's. 

### Map functions:
```{r}
(means_Asia <- co2_data %>% filter(continent == "asia") %>% select(forest_coverage_percent) %>% map(mean, na.rm = T))

(means_n_america <- co2_data %>% filter(continent_spec == "america_north") %>% select(forest_coverage_percent) %>% map(mean, na.rm = T))


(standard_dev_Asia <- co2_data %>% filter(continent == "asia") %>% select(forest_coverage_percent) %>% map(sd, na.rm = T))

(standard_dev_n_america <- co2_data %>% filter(continent_spec == "america_north") %>% select(forest_coverage_percent) %>% map(sd, na.rm = T))


```
The four above map functions work to provide important statistical datapoints for the two regions being analyzed in the above question,  with the first two data points representing the means of forest coverage percentage in Asia and North America, respectively, whereas the second two represent the dstandard deviations of forest coverage percentage in Asia and North America, again respectively. These map functions were performed by first filtering the data for each respective continent, selecting the requisuite vartiable, and then taking the mapped mean or standard deviation of each dataset, removing any N.A. data points. 

### Permutation Test

**Null Hypothesis:** The mean forest coverage percentage between the two continents is equal.
**Alternative Hypothesis:** The mean forest coverage percentage between the two continents is not equal. 

```{r}
asian_countries <- co2_data %>% filter(continent == "asia")
n_american_countries <- co2_data %>% filter(continent_spec == "america_north")
asia_and_n_america_forests <- co2_data %>% filter(continent == "asia" | continent_spec == "america_north")

real_mean <- mean(n_american_countries$forest_coverage_percent, na.rm = T) - mean(asian_countries$forest_coverage_percent, na.rm = T)

permuted_means <- tibble(permuted_means = perm_mean(10000, asia_and_n_america_forests$forest_coverage_percent, 1000))

(percentile_forest_means<-nrow(filter(permuted_means,permuted_means<real_mean))/nrow(permuted_means))

ggplot(data = permuted_means, mapping = aes(permuted_means, fill=(permuted_means<quantile(permuted_means,probs = c(.05),na.rm=T)[[1]]|permuted_means>quantile(permuted_means,probs = c(.95),na.rm=T)[[1]]))) +   geom_histogram(binwidth = 0.25)+
  geom_vline(xintercept = real_mean,color="blue")+
  labs(title=" Mean Permutation Test Between Forest 
       Coverage Percentage in Asia and North America",fill="Tails")
```

### Conclusion 

As seen in the histogram above, the null hypothesis can clearly be rejected, as the real difference between the two means is well outside of the range of statistically expected data. In fact, the real difference is actually in the 100th percentile of the permuted means difference. Therefore, it can be seen that there is a statistically signifcant difference in forest coverage percentage between the two continents.  




