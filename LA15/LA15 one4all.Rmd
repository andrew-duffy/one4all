---
title: "LA15 one4all"
output: html_document
---
Andrew Duffy, Braden Greibel, Luke Fanning, Ahyo Falick.

### This dataset comes from data.worldbank.org. 
It is a very large selection of statistics with a domain of almost every country, worldwide. It ranges from years 1995-2019.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(purrr)
```

```{r}
df <- read_csv(file = "data1.csv", col_types=cols(CreationDate=col_datetime()))
info <- read_csv(file = "data2.csv")

colnames(df) <- c("Country", "Abbreviation", "Measuring", "Code", "1995", "1996", "1997", "1998", "1999", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019")

worlddata <- df %>% group_by(Country) %>% nest()
df<-df[,-29]

df<-df%>%gather(`1995`:`2019`,key=year,value=measurement)%>%select(Country,Measuring,year,measurement)%>%filter(Country!="Data from database: World Development Indicators")%>%
  filter(Country!="Last Updated: 10/28/2019")%>%filter(!is.na(Country))


countries<-unique(df$Country)
#countries

afghanistan<-df%>%filter(Country=="Afghanistan")%>%spread(key=Measuring,value=measurement)

cleaned<-afghanistan

countries<-countries[-1]
for(i in 1:length(countries)){
  temp<-df%>%filter(Country==countries[i])%>%spread(key=Measuring,value=measurement)
  cleaned<-rbind(cleaned,temp)
}


cleaned
```

# Team Question:

Does female HIV rate have a correlation with life expectancy and literacy rate? Expect the correlation to be inverse, where an increase in HIV rate leads to a decrease in life expectancy.

Null Hypothesis: There is no inverse correlation between HIV rate and test statistics Literacy and Life expectancy.

Alternate Hypothesis: There is an inverse correlation between HIV rate and test statistics life expectancy and literacy rate.

*note: measuring female stastic of HIV rate because male data is unavailable.


```{r}
colnames(cleaned)
```

```{r}
tdata<-cleaned%>%select(Country,year,GDPpc=`GDP per capita (current US$)`,Literacy= `Literacy rate, adult total (% of people ages 15 and above)`,Life_exp=`Life expectancy at birth, total (years)`,
                        HIV=`Women's share of population ages 15+ living with HIV (%)`)

tdata<-tdata%>%mutate(year=as.double(year),GDPpc=as.double(GDPpc),Literacy=as.double(Literacy),Life_exp=as.double(Life_exp),HIV=as.double(HIV))

tdata

```

First, we should graph the data, by year. Then, we will perform a permutation correlation test with the variables we wish to find a correlation. 

We will start with graphing the yearly average of each statistic, worldwide, to get a look at the graphs and see if any graphs look correlated. We will add GDP per capita to get a decent understanding of the world's economic standing.

Two Statistics that jump out at me in terms of potential correlation is Life Expectancy and HIV rate. Note that HIV will have an inverse effect on Life expectancy until the life-saving medication is discovered for it. 

```{r, message = FALSE, warning = FALSE}
visualdata <- tdata %>% group_by(year)

visualdata <- visualdata[, -1]


ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = HIV), se = FALSE) + ggtitle("Worldwide rate of Women with HIV") + labs(x = "Year", y = "Female HIV rate")

ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = Life_exp), se = FALSE) + ggtitle("Worldwide rate of Life Expectancy") + labs(x = "Year", y = "Life Expectancy")

ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = GDPpc), se = FALSE) + ggtitle("Worldwide average of GDP per capita") + labs(x = "Year", y = "GDP per capita (US$)")

ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = Literacy), se = FALSE) + ggtitle("Worldwide Literacy rate") + labs(x = "Year", y = "Literacy rate")


```

As we can see, the graph of hiv rate has a slight upward pointing "bump" in the trend line that is otherwise linear. The graph of life expectancy has a inversely related shift, pointing at a potential negative correlation before life-saving medication is created (in the mid 2000's).

Now that we have visualized the worldwide averages of our test statistics, lets take a look at a few different countries. Since HIV is most rampant in Africa, lets take a look at the same test statistics for South Africa (a country very devastated by HIV). Then, since worldwide prevelance of HIV is pretty consistent accros Europe and North America, lets take a look at a country in the EU, such as the UK.

```{r, message = FALSE, warning = FALSE}
sadata <- tdata %>% filter(Country == "South Africa") %>% group_by(year)

ggplot(data = sadata) + geom_smooth(mapping = aes(x = year, y = HIV), se = FALSE) + ggtitle("Worldwide rate of Women with HIV") + labs(x = "Year", y = "Female HIV rate")

ggplot(data = sadata) + geom_smooth(mapping = aes(x = year, y = Life_exp), se = FALSE) + ggtitle("Worldwide rate of Life Expectancy") + labs(x = "Year", y = "Life Expectancy")

ggplot(data = sadata) + geom_smooth(mapping = aes(x = year, y = GDPpc), se = FALSE) + ggtitle("Worldwide average of GDP per capita") + labs(x = "Year", y = "GDP per capita")

ggplot(data = sadata) + geom_smooth(mapping = aes(x = year, y = Literacy), se = FALSE) + ggtitle("Worldwide Literacy rate") + labs(x = "Year", y = "Literacy rate")

```

We can interpret from South Africa that the graphs of HIV rate and Life Expectancy have an extremely large negative correlation up until around 2006.


```{r, message = FALSE, warning = FALSE}
ukdata <- tdata %>% filter(Country == "United Kingdom") %>% group_by(year)

ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = HIV), se = FALSE) + ggtitle("Worldwide rate of Women with HIV") + labs(x = "Year", y = "Female HIV rate")

ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = Life_exp), se = FALSE) + ggtitle("Worldwide rate of Life Expectancy") + labs(x = "Year", y = "Life Expectancy")

ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = GDPpc), se = FALSE) + ggtitle("Worldwide average of GDP per capita") + labs(x = "Year", y = "GDP per capita")

ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = Literacy), se = FALSE) + ggtitle("Worldwide Literacy rate") + labs(x = "Year", y = "Literacy rate")

```


UK results are very similar to worldwide results, especially in terms of HIV rate and Life expectancy. Where there is a slight exponential increase in HIV rate, there is a slight exponential decrease in Life Expectancy. A small but not negligible negative correlation is visible from the graphs of these test statistics.


Now for the permutation test.


```{r}
perm_cor <- function(perms = 1000, x, y)
{
  ## Variables ##
  # perms: The number of permutations 
  # x: Vector of Variable 1 - for computing correlation
  # y: Vector of Variable 2 - for computing correlation
  ###############
  
  # Step 1:
  # Create vector of zeroes of length "perms" to store
  # permuted mean differnces
  diff_vector2 <- rep(0,perms)
  
  
  
  # Loop throught number of permutations
  for (i in c(1:perms))
  {
    # Step 2:
    # Randomly mix up the values in the vector "y"
    
    ymix <- sample(y)
    
    # Step 3:
    # Compute the correlation between x and the randomly mixed
    # up y-vector. Store this value in the vector from step 1.
    
    diff_vector2[i] <- cor(x, ymix)
    
  }
  
  # Step 4:
  # Return new updated vector, created in step 1
  return(diff_vector2)
}
```










## Andrew Duffy Individual Question:

### Subquestion: 

Does urban population growth have an effect on hiv rate in Africa? That is, is there a correlation between female HIV rate and urban population growth?

Null Hypothesis: There is no correlation between female HIV rate and urban population growth in Africa.

Alternate Hypothesis: There is a significant correlation between female HIV rate and urban population growth in Africa.



Start off with extracting a data frame from the large set of data we cleaned up. 

```{r}
urbanHIV <- cleaned %>% select(Country,year, HIV=`Women's share of population ages 15+ living with HIV (%)`, Urban = `Urban population growth (annual %)`)

urbanHIV <- urbanHIV %>% mutate(year=as.double(year), HIV=as.double(HIV), Urban = as.double(Urban))
```


First, lets graph findings, for both worldwide and for a country that is devastated by aids, as well as a country not devastated by aids.

```{r}
ggplot(data = urbanHIV) + geom_smooth(mapping = aes(x = year, y = Urban), se = FALSE) + ggtitle("Worldwide Urban Population growth") + labs(x = "Year", y = "Urban Population Growth, %")

#we have already seen the worldwide hiv rate graph, but here it is again for good measure

ggplot(data = urbanHIV) + geom_smooth(mapping = aes(x = year, y = HIV), se = FALSE) + ggtitle("Worldwide rate of Women with HIV") + labs(x = "Year", y = "Female HIV rate")

```

As you can see, on a global scale there seems to be no correlation whatsoever between urban population growth and female HIV rate.

Now, lets test France and Mongolia.

```{r}
mongolia <- urbanHIV %>% filter(Country == "Mongolia")

ggplot(data = mongolia) + geom_smooth(mapping = aes(x = year, y = Urban), se = FALSE) + ggtitle("Mongolia's Urban Population growth") + labs(x = "Year", y = "Urban Population Growth, %")

ggplot(data = mongolia) + geom_smooth(mapping = aes(x = year, y = HIV), se = FALSE) + ggtitle("Mongolia's rate of Women with HIV") + labs(x = "Year", y = "Female HIV rate")
```

Visually, one can see that the graphs seem to have a similar path up until 2005-2006. Then the graphs become reciprocal of each other.

```{r}
Fr <- urbanHIV %>% filter(Country == "France")

ggplot(data = Fr) + geom_smooth(mapping = aes(x = year, y = Urban), se = FALSE) + ggtitle("France Urban Population growth") + labs(x = "Year", y = "Urban Population Growth, %")


ggplot(data = Fr) + geom_smooth(mapping = aes(x = year, y = HIV), se = FALSE) + ggtitle("France's rate of Women with HIV") + labs(x = "Year", y = "Female HIV rate")
```

As you can see, the graphs are similar in function to those of Mongolia


Now we will perform the permutation correlation test to see if there is any correlation between the two. We will run this with a sample of a few African countries then compare to France, since France seemed to have a surprisingly similar trend line for urban population growth and HIV rate. I will do the test up to 2006 because that is where HIV seems to be stop being a very life-threatening disease due to modern medicine and political acts, such as President George Bush's push to move high quantities of new HIV medication into Africa in 2003.

```{r}
AFsample <- urbanHIV %>% filter(year <= "2006") %>% filter(Country == "South Africa" | Country == "Mongolia" | Country == "Central African Republic" | Country == "Ethiopia")

AFRresults <- perm_cor(perms = 1000, AFsample$Urban, AFsample$HIV)

FRresults <- perm_cor(perms = 1000, Fr$Urban, Fr$HIV)

AFRresults
FRresults
```

in order to compare these results, we must find a single number to compare them with. I'll use the mean of the 1000 results for each, to compare the two. 

```{r}
afrmean <- mean(AFRresults)
frmean <- mean(FRresults)
```

The mean of the African sample test is:

```{r}
afrmean
```

The mean of the France test is:

```{r}
frmean
```

These results show that there is actually a greater correlation between HIV rate and urban population growth in France than in the sample of African countries. This is very surprising, but even more surprising is the fact that there seems to be a negative correlation in the African sample test. 


Both of these correlation results are extremely close to 0, so the null hypothesis would not be rejected anyways, but the fact that the correlation for the African sample is negative means there is no way to reject the null hypothesis.

These findings mean that there is no correlation between urban population growth and female HIV rate in Africa.

