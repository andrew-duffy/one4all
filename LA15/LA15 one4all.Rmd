---
title: "LA15 one4all"
output: html_document
---
Andrew Duffy, Braden Greibel, Luke Fanning, Ahyo Falick.

### This dataset comes from data.worldbank.org. 
It is a very large selection of statistics with a domain of almost every country, worldwide. It ranges from years 1995-2019.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(purrr)
library(modelr)

```

```{r message=F , warning=F}
perm_mean <- function(perms = 1000, all_values, n_A)
{
  ## Variables ##
  # perms: The number of permutations 
  # all_values (num): all data values
  # n_A (int): Size of group A
  ###############
  
  # Step 1:
  # Create vector of zeroes of length "perms" to store
  # permuted mean differnces
  permuted_mean_differences<-rep(0,perms)
  
  # Loop throught number of permutations
  for (i in c(1:perms))
  {
    # Step 2:
    # Randomly separate vector "values" into disjoint 
    # groups of size "nA" and "nB" respectively
    temp<-sample(all_values)
    group_A<-temp[1:n_A]
    group_B<-temp[(n_A+1):length(temp)]
    
    # Step 3:
    # Compute the sample means for the two groups from 
    # step 2
    mean_A<-mean(group_A,na.rm=T)
    mean_B<-mean(group_B,na.rm=T)
    
    
    # Step 4: 
    # Compute the difference in sample means, store the
    # value in the vector from step 1
    permuted_mean_differences[i]<-mean_A-mean_B
    
  }
  
  # Step 5:
  # Return the permuted mean differences vector
  return(permuted_mean_differences)
  
}
```


```{r message=F , warning=F}
perm_cor <- function(perms = 1000, x, y)
{
  ## Variables ##
  # perms: The number of permutations 
  # x: Vector of Variable 1 - for computing correlation
  # y: Vector of Variable 2 - for computing correlation
  ###############
  
  # Step 1:
  # Create vector of zeroes of length "perms" to store
  # permuted mean differnces
  correlations<-rep(0,perms)
  
  
  # Loop throught number of permutations
  for (i in c(1:perms))
  {
    # Step 2:
    # Randomly mix up the values in the vector "y"
    temp<-sample(y)
    
    # Step 3:
    # Compute the correlation between x and the randomly mixed
    # up y-vector. Store this value in the vector from step 1.
    correlations[i]<-cor(x,temp,use="pairwise.complete.obs")
    
  }
  
  # Step 4:
  # Return new updated vector, created in step 1
  return(correlations)
  
}

```



```{r}
df <- read_csv(file = "data1.csv", col_types=cols(CreationDate=col_datetime()))
info <- read_csv(file = "data2.csv")

colnames(df) <- c("Country", "Abbreviation", "Measuring", "Code", "1995", "1996", "1997", "1998", "1999", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019")

worlddata <- df %>% group_by(Country) %>% nest()
df<-df[,-29]

df<-df%>%gather(`1995`:`2019`,key=year,value=measurement)%>%select(Country,Measuring,year,measurement)%>%filter(Country!="Data from database: World Development Indicators")%>%
  filter(Country!="Last Updated: 10/28/2019")%>%filter(!is.na(Country))


countries<-unique(df$Country)
#countries

afghanistan<-df%>%filter(Country=="Afghanistan")%>%spread(key=Measuring,value=measurement)

cleaned<-afghanistan

countries<-countries[-1]
for(i in 1:length(countries)){
  temp<-df%>%filter(Country==countries[i])%>%spread(key=Measuring,value=measurement)
  cleaned<-rbind(cleaned,temp)
}


cleaned
```

# Team Question:

Does female HIV rate have a correlation with literacy rate  and life expectancy?

*note: measuring female stastic of HIV rate because male data is unavailable.



```{r}
tdata<-cleaned%>%select(Country,year,GDPpc=`GDP per capita (current US$)`,Literacy= `Literacy rate, adult total (% of people ages 15 and above)`,Life_exp=`Life expectancy at birth, total (years)`,
                        HIV=`Women's share of population ages 15+ living with HIV (%)`)

tdata<-tdata%>%mutate(year=as.double(year),GDPpc=as.double(GDPpc),Literacy=as.double(Literacy),Life_exp=as.double(Life_exp),HIV=as.double(HIV))

tdata

```

First, we should graph the data, by year. Then, we will perform a permutation correlation test with the variables we wish to find a correlation. 

We will start with graphing the yearly average of each statistic, worldwide, to get a look at the graphs and see if any graphs look correlated.

Two Statistics that jump out at me in terms of potential correlation is Life Expectancy and HIV rate. Note that HIV will have an inverse effect on Life expectancy until the life-saving medication is discovered for it. 

```{r, message = FALSE, warning = FALSE}
visualdata <- tdata %>% group_by(year)

visualdata <- visualdata[, -1]


ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = HIV), se = FALSE) + ggtitle("Worldwide rate of Women with HIV") + labs(x = "Year", y = "Female HIV rate")

ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = Life_exp), se = FALSE) + ggtitle("Worldwide rate of Life Expectancy") + labs(x = "Year", y = "Life Expectancy")

ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = GDPpc), se = FALSE) + ggtitle("Worldwide average of GDP per capita") + labs(x = "Year", y = "GDP per capita")

ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = Literacy), se = FALSE) + ggtitle("Worldwide Literacy rate") + labs(x = "Year", y = "Literacy rate")


```

As we can see, the graph of hiv rate has a slight upward pointing "bump" in the trend line that is otherwise linear. The graph of life expectancy has a inversely related shift, pointing at a potential negative correlation before life-saving medication is created (in the mid 2000's).

Now that we have visualized the worldwide averages of our test statistics, lets take a look at a few different countries. Since HIV is most rampant in Africa, lets take a look at the same test statistics for South Africa (a country very devastated by HIV). Then, since worldwide prevelance of HIV is pretty consistent accros Europe and North America, lets take a look at a country in the EU, such as the UK.

```{r, message = FALSE, warning = FALSE}
sadata <- tdata %>% filter(Country == "South Africa") %>% group_by(year)

ggplot(data = sadata) + geom_smooth(mapping = aes(x = year, y = HIV), se = FALSE) + ggtitle("South Africa rate of Women with HIV") + labs(x = "Year", y = "Female HIV rate")

ggplot(data = sadata) + geom_smooth(mapping = aes(x = year, y = Life_exp), se = FALSE) + ggtitle("South Africa Life Expectancy") + labs(x = "Year", y = "Life Expectancy")

ggplot(data = sadata) + geom_smooth(mapping = aes(x = year, y = GDPpc), se = FALSE) + ggtitle("South Africa GDP per capita") + labs(x = "Year", y = "GDP per capita")

ggplot(data = sadata) + geom_smooth(mapping = aes(x = year, y = Literacy), se = FALSE) + ggtitle("South Africa Literacy rate") + labs(x = "Year", y = "Literacy rate")

```

We can interpret from South Africa that the graphs of HIV rate and Life Expectancy have an extremely large negative correlation up until around 2006.


```{r, message = FALSE, warning = FALSE}
ukdata <- tdata %>% filter(Country == "United Kingdom") %>% group_by(year)

ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = HIV), se = FALSE) + ggtitle("Worldwide rate of Women with HIV") + labs(x = "Year", y = "Female HIV rate")

ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = Life_exp), se = FALSE) + ggtitle("Worldwide rate of Life Expectancy") + labs(x = "Year", y = "Life Expectancy")

ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = GDPpc), se = FALSE) + ggtitle("Worldwide average of GDP per capita") + labs(x = "Year", y = "GDP per capita")

ggplot(data = visualdata) + geom_smooth(mapping = aes(x = year, y = Literacy), se = FALSE) + ggtitle("Worldwide Literacy rate") + labs(x = "Year", y = "Literacy rate")

```


UK results are very similar to worldwide results, especially in terms of HIV rate and Life expectancy. Where there is a slight exponential increase in HIV rate, there is a slight exponential decrease in Life Expectancy. A small but not negligible negative correlation is visible from the graphs of these test statistics.


Now for the permutation test.

```{r}
lit<-tdata$Literacy
HIV<-tdata$HIV
lifeExp<-tdata$Life_exp
cor_lit_le<-cor(lit,lifeExp,use = "pairwise.complete.obs")
cor_HIV_le<-cor(HIV,lifeExp,use="pairwise.complete.obs")

pc_lit_le<-tibble(cor=perm_cor(perms=1000,lit,lifeExp))
pc_HIV_le<-tibble(cor=perm_cor(perms=1000,HIV,lifeExp))



plow_lit_le<-quantile(pc_lit_le$cor,probs=.025)[[1]]
phigh_lit_le<-quantile(pc_lit_le$cor,probs=.975)[[1]]
  
plow_HIV_le<-quantile(pc_HIV_le$cor,probs=.025)[[1]]
phigh_HIV_le<-quantile(pc_HIV_le$cor,probs=.975)[[1]]

ggplot(pc_lit_le,aes(cor,fill=(cor<plow_lit_le|cor>phigh_lit_le)))+geom_histogram(binwidth = .01)+geom_vline(xintercept = cor_lit_le)+
  labs(title="Literacy rate and Life Expectancy Permutation Correlation Test",
       x="Correlation Between Literacy rate and Life Expectancy",
       fill="Tails")


ggplot(pc_HIV_le,aes(cor,fill=(cor<plow_HIV_le|cor>phigh_HIV_le)))+geom_histogram(binwidth = .01)+geom_vline(xintercept = cor_HIV_le)+
  labs(title="Female HIV rate and Life Expectancy permutation Correlation Test",
       x="Correlation between Female HIV rate and Life Expectancy",
       fill="Tails")

percentile_lit_le<-nrow(filter(pc_lit_le,cor<cor_lit_le))/nrow(pc_lit_le)
percentile_HIV_le<-nrow(filter(pc_HIV_le,cor<cor_HIV_le))/nrow(pc_HIV_le)


ptable<-tibble("Percentile of:"=c("Literacy Rate and Life Expectancy Permutation Correlation Test","Female HIV Rate and Life Expectancy Permutation Correlation Test"),"Value:"=
                 c(percentile_lit_le,percentile_HIV_le))
ptable



```












































## Braden Griebel Individial Section:


### Question:
What is the relationship between Literacy and Life expectancy when accounting for 



### Using Linear Models to Gain Insight

```{r}
bdata<-tdata%>%select(-HIV)

bmodel<-lm(Life_exp~GDPpc,data=bdata)
bdata<-add_residuals(bdata,model=bmodel,var="resid_le")
bdata

ggplot(bdata,aes(x=Literacy,y=Life_exp,color=log(GDPpc,base = 10)))+geom_point()+geom_smooth(se=F,color="red")+labs(title="Literacy, Life Expectancy and GDP per capita",
                                                                                                    x="Literacy Rate",
                                                                                                    y="Life Expectancy",
                                                                                                    color="Base 10 Log of GDP",
                                                                                                    caption="Log used to show order of magnitude since it spans many orders of magnitude")                                                                                                    

ggplot(bdata,aes(x=Literacy,y=resid_le))+geom_jitter()+geom_smooth(se=F,color="red")+labs(title="Literacy and Residuals of Life Expectancy",
                                                                              caption="Residuals Generated After removing effect of GDP per Capita",
                                                                              x="Literacy Rate",y="Residuals")

ggplot(bdata,aes(x=Literacy,y=resid_le))+geom_jitter()+geom_smooth(se=F,color="red")+xlim(85,100)+labs(title="Literacy and Residuals of Life Expectancy", subtitle = "Zoomed into 85-100% Literacy",
                                                                              caption="Residuals Generated After removing effect of GDP per Capita",
                                                                              x="Literacy Rate",y="Residuals")


bmodel2<-lm(Life_exp~GDPpc+Literacy,data=bdata)
print("Coefficients of Linear Model Including Per Capita GDP and Literacty Rate")
tibble(Measurement=c("Intercept","GDP per Capita", "Literacy Rate"),"Coefficient Value"= coef(bmodel2))
```


### Is there a difference in the literacy rates between the highest 50% of Life Expectancy, and the Lowest 50%?

```{r}
high_le<-bdata%>%filter(Life_exp>median(bdata$Life_exp,na.rm=T))
low_le<-bdata%>%filter(Life_exp<=median(bdata$Life_exp,na.rm=T))
c_mean_diff<-mean(high_le$Literacy,na.rm=T)-mean(low_le$Literacy,na.rm=T)


permuted_means<-tibble(lit_mean_diff=perm_mean(perms=1000,all_values = c(low_le$Literacy,high_le$Literacy),n_A=nrow(high_le)))

p2.5<-quantile(permuted_means$lit_mean_diff, probs=.025)[[1]]
p97.5<-quantile(permuted_means$lit_mean_diff, probs=.975)[[1]]

ggplot(data=permuted_means,aes(lit_mean_diff,fill=(lit_mean_diff<p2.5|lit_mean_diff>p97.5)))+geom_histogram()+geom_vline(xintercept = c_mean_diff)+
  labs(title="Permuted Difference of Means",fill="Tails",x="Difference of the Means of Literacy")

percentile<-nrow(filter(permuted_means,lit_mean_diff<c_mean_diff))/nrow(permuted_means)

print(paste("The Computed difference of Means is in the ",percentile*100,"th percentile",sep = ""))

```

### Is there a correlation between Literacy and the Calculated Residuals?
```{r}
resids<-bdata$resid_le
lit<-bdata$Literacy
calculated_correlation<-cor(lit,resids,use="pairwise.complete.obs")
permuted_correlations<-tibble(correlations=perm_cor(perms=1000,lit,resids))
p2.5<-quantile(permuted_correlations$correlations, probs=.025)[[1]]
p97.5<-quantile(permuted_correlations$correlations, probs=.975)[[1]]

ggplot(data=permuted_correlations,aes(correlations,fill=(correlations<p2.5|correlations>p97.5)))+geom_histogram()+geom_vline(xintercept = calculated_correlation)+
  labs(title="Permuted Correlations Between Literacy and Life Expectancy",x="Correlations",fill="Tails")

percentile<-nrow(filter(permuted_correlations,correlations<calculated_correlation))/nrow(permuted_correlations)

print(paste("The Computed Correlation is in the ",percentile*100,"th percentile",sep = ""))

```

















## Reflections:
### Team Reflection:

In the beggining of the semester our team goal was to "To learn techniques to explore and understand data, as well as being able to present that data in an clear, attractive and intriguing way".














how have your six-month or 5-year goals changed? What did you learn/accomplish in this course? If you could give yourself advice at the beginning of the semester, what would you tell yourself to keep doing, stop doing, and start doing?
### Braden Reflection:
At the start of the semester my six month goal was "to be in grad school, I donâ€™t know specifically for what, but hopeully something related to statistics." and my five year post graduation goal was "I hope to be working on epidemiology for the CDC".

